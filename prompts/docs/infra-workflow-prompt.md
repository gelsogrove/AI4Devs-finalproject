# Terraform Infrastructure Workflow Generation Prompt

## üö® CRITICAL ERROR PREVENTION RULES

### 1. **Terraform Configuration Validation**
- ‚úÖ **ALWAYS** validate all resource dependencies before generation
- ‚úÖ **NEVER** use `templatefile()` - use inline `<<-EOF` heredoc syntax
- ‚úÖ **ALWAYS** ensure proper resource ordering (VPC ‚Üí Subnets ‚Üí Security Groups ‚Üí EC2/RDS)
- ‚úÖ **VALIDATE** all variable interpolations use correct syntax: `${var.name}` not `${name}`
- ‚úÖ **TEST** all provider versions are compatible (AWS ~> 5.0, TLS ~> 4.0, Random ~> 3.1)

### 2. **Resource Dependencies & References**
- ‚úÖ **EXPLICIT** dependencies: EC2 depends on VPC, Subnets, Security Groups, Key Pair
- ‚úÖ **DATABASE** dependencies: RDS depends on DB Subnet Group, Security Group, Password
- ‚úÖ **SECRETS** dependencies: Secrets Manager version depends on secret and RDS instance
- ‚úÖ **AVOID** circular dependencies in resource references

### 3. **Common Error Patterns to AVOID**
- ‚ùå **NEVER** reference resources before they're defined
- ‚ùå **NEVER** use `file()` function for non-existent files
- ‚ùå **NEVER** create complex nested templatefile structures
- ‚ùå **NEVER** use undefined variables or outputs
- ‚ùå **NEVER** mix resource creation with external file dependencies

### 4. **AMI Query Best Practices (CRITICAL)**
- ‚úÖ **USE GENERIC PATTERNS**: `ubuntu/images/hvm-ssd/ubuntu-*-amd64-server-*` not specific versions
- ‚úÖ **ALWAYS** include `most_recent = true` for AMI data sources
- ‚úÖ **VERIFY** owner IDs: Canonical = `099720109477`, Amazon = `137112412989`
- ‚úÖ **MINIMAL FILTERS**: Only use essential filters (name, virtualization-type)
- ‚ùå **AVOID** overly specific version filters like `ubuntu-22.04` that may not exist
- ‚ùå **AVOID** unnecessary filters like `state = available` (implied by most_recent)

### 5. **User Data Simplification Rules**
- ‚úÖ **KEEP SIMPLE**: Basic package installation only in initial deployment
- ‚úÖ **AVOID HEREDOC NESTING**: No complex bash scripts with multiple heredoc blocks
- ‚úÖ **ESCAPE VARIABLES**: Use `\$` for bash variables in Terraform heredoc
- ‚úÖ **MINIMAL SETUP**: nginx, basic status page, essential packages only
- ‚ùå **NO COMPLEX CONFIGS**: Avoid inline nginx config files in user data

## Infrastructure Requirements

### Core Infrastructure (MANDATORY)
1. **AWS Provider Setup** - Configure AWS credentials and Terraform with proper versions
2. **VPC & Networking** - Create VPC, public/private subnets, internet gateway, route tables
3. **Security Groups** - Web server (SSH, HTTP, HTTPS, 8080) and database security groups  
4. **SSH Key Generation** - Use TLS provider to generate RSA 4096-bit key pair
5. **EC2 Instance** - t3.micro Ubuntu with SIMPLE user data (no complex scripts)
6. **RDS PostgreSQL** - Managed database in private subnets with proper security
7. **S3 Bucket** - For deployments with versioning and encryption
8. **Secrets Manager** - Database credentials with proper JSON structure
9. **Elastic IP** - Static IP for web server

### Simplified Approach (TESTED PATTERN)
10. **User Data** - MINIMAL inline script (apt update, install nginx, basic setup)
11. **No Complex IAM** - Avoid complex IAM roles that can cause permission errors
12. **No External Files** - Everything inline in main.tf
13. **Proper Outputs** - All required outputs with correct sensitivity settings
14. **Generic AMI Query** - Use flexible patterns that work across regions/time

## Workflow Features

### GitHub Actions Integration
15. **Manual Trigger** - workflow_dispatch with action choice (plan/apply/destroy)
16. **Instance Type Selection** - t3.micro/small/medium dropdown options
17. **Environment Targeting** - Use `environment: dev` for secrets consistency
18. **Terraform Generation** - Single main.tf file with all resources inline
19. **Error Handling** - Proper error messages and debugging information
20. **Secrets Auto-Update** - GitHub CLI integration to update environment secrets

### Output & Reporting
21. **Connection Details** - Public IP, DNS, SSH command, S3 bucket
22. **Cost Estimation** - Display monthly cost (~$27-30)
23. **Next Steps** - Clear instructions for deployment workflow
24. **Secret Status** - List all auto-configured secrets

## Required GitHub Secrets (Environment: dev)

### AWS Infrastructure
- **AWS_ACCESS_KEY_ID** - AWS access key for Terraform operations
- **AWS_SECRET_ACCESS_KEY** - AWS secret key for Terraform operations

### Application APIs  
- **OPENROUTER_API_KEY** - API key for ChatGPT/Claude LLM integration
- **HUGGINGFACE_API_KEY** - API key for embeddings and document search
- **JWT_SECRET** - Secret key for authentication tokens

### Auto-Generated by Terraform
- **S3_BUCKET_NAME** - S3 bucket for deployments
- **EC2_HOST** - Public IP of EC2 instance
- **EC2_USER** - SSH username (ubuntu)
- **EC2_SSH_KEY** - Private SSH key for server access
- **AWS_REGION** - AWS region (us-east-1)
- **DATABASE_URL** - Complete PostgreSQL connection string
- **DB_NAME, DB_USER, DB_PASSWORD, DB_HOST** - Individual database credentials

## Technical Specifications

### Infrastructure Details
- **Region**: us-east-1 (2 availability zones)
- **Environment**: Development/Production compatible
- **VPC CIDR**: 10.0.0.0/16
- **Public Subnets**: 10.0.1.0/24, 10.0.2.0/24
- **Private Subnets**: 10.0.10.0/24, 10.0.11.0/24

### Database Configuration
- **Engine**: PostgreSQL 15.4
- **Instance**: db.t3.micro
- **Storage**: 20GB GP2, encrypted, auto-scaling to 100GB
- **Backup**: 7-day retention, automated maintenance windows
- **Network**: Private subnets only, security group restricted

### Security & Access
- **SSH**: RSA 4096-bit keys, auto-generated
- **Database**: Private access only from EC2 security group
- **S3**: Encrypted, versioned, private access
- **Secrets**: AWS Secrets Manager with automatic rotation support

## üîß TERRAFORM GENERATION RULES

### File Structure
```
terraform/
‚îú‚îÄ‚îÄ main.tf (ALL resources in single file)
‚îî‚îÄ‚îÄ (NO external files - everything inline)
```

### Resource Order (CRITICAL)
1. Providers and variables
2. Data sources (AZs, AMI with generic patterns)
3. Random resources (password, bucket suffix)
4. VPC and networking
5. Security groups
6. TLS private key and AWS key pair
7. S3 bucket and configuration
8. Secrets Manager (secret only)
9. DB subnet group
10. RDS instance
11. Secrets Manager version (AFTER RDS with depends_on)
12. EC2 instance (depends on all above)
13. Elastic IP
14. Outputs

### Testing Strategy
- **Plan First**: Always run `terraform plan` before `apply`
- **Incremental**: Start with basic resources, add complexity gradually
- **Validation**: Use `terraform validate` in workflow
- **Error Recovery**: Provide clear error messages and troubleshooting steps

### Proven AMI Data Source Pattern
```hcl
data "aws_ami" "ubuntu" {
  most_recent = true
  owners      = ["099720109477"] # Canonical
  
  filter {
    name   = "name"
    values = ["ubuntu/images/hvm-ssd/ubuntu-*-amd64-server-*"]
  }
  
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
}
```

### Proven User Data Pattern
```hcl
user_data = base64encode(<<-EOF
  #!/bin/bash
  apt-get update
  apt-get install -y nginx
  systemctl start nginx
  systemctl enable nginx
  echo "<h1>ShopMefy Server Ready</h1>" > /var/www/html/index.html
EOF
)
```

## üéØ SUCCESS CRITERIA

### Workflow Must Pass These Tests
1. ‚úÖ `terraform init` - Downloads providers successfully
2. ‚úÖ `terraform validate` - Configuration is syntactically correct
3. ‚úÖ `terraform plan` - Shows expected resources without errors
4. ‚úÖ AMI query returns results in us-east-1
5. ‚úÖ All resource dependencies resolved correctly
6. ‚úÖ No circular dependency errors
7. ‚úÖ All outputs defined and accessible

### Common Failure Points to Check
- ‚ùå AMI query returns no results (use generic patterns)
- ‚ùå Unterminated template strings (avoid nested heredoc)
- ‚ùå Circular dependencies (RDS endpoint in secrets before RDS creation)
- ‚ùå Missing depends_on declarations
- ‚ùå Invalid resource references
- ‚ùå Provider version conflicts

