# Terraform Infrastructure Documentation

## üèóÔ∏è CURRENT INFRASTRUCTURE SETUP

### **ShopMefy AWS Infrastructure**
The application uses a **simplified AWS infrastructure** with the following components:

## Infrastructure Components

### **1. EC2 Instance** üñ•Ô∏è
- **Instance Type**: `t3.small` (2GB RAM, 1 vCPU)
- **AMI**: Ubuntu 22.04 LTS (latest)
- **Storage**: 20GB GP3 encrypted EBS volume
- **Network**: Public subnet with Elastic IP
- **User Data**: Node.js 20.x + PM2 + Nginx setup

### **2. RDS PostgreSQL Database** üóÑÔ∏è
- **Engine**: PostgreSQL 15.7
- **Instance**: `db.t3.micro` (1GB RAM)
- **Storage**: 20GB GP2 with auto-scaling
- **Network**: Private subnets only
- **Backup**: 1-day retention, skip final snapshot

### **3. S3 Bucket** üì¶
- **Purpose**: Document uploads and file storage
- **Encryption**: AES256 server-side encryption
- **Versioning**: Enabled for data protection
- **Access**: Private with restricted bucket policy

### **4. Networking** üåê
- **VPC**: Default VPC (existing)
- **Subnets**: Uses existing default subnets
- **Security Groups**: Web (ports 22,80,443,3000,8080) + DB (port 5432)
- **Elastic IP**: Fixed public IP address

### **5. SSH Access** üîë
- **Key Type**: RSA 4096-bit auto-generated
- **Storage**: Private key in Terraform output
- **Access**: SSH to ubuntu user on EC2

## Terraform Configuration

### **File Structure**
```
terraform/
‚îú‚îÄ‚îÄ main.tf          # All infrastructure resources
‚îú‚îÄ‚îÄ variables.tf     # Input variables (region, db_password)
‚îú‚îÄ‚îÄ outputs.tf       # Infrastructure outputs
‚îî‚îÄ‚îÄ .terraform.lock.hcl  # Provider version lock
```

### **Key Features**
- ‚úÖ **Single File**: All resources in main.tf
- ‚úÖ **Default VPC**: Uses existing AWS default VPC
- ‚úÖ **Auto-Generated**: SSH keys and random passwords
- ‚úÖ **Minimal Setup**: Essential resources only
- ‚úÖ **Cost Optimized**: ~$16-17/month running cost

## Resource Dependencies

### **Dependency Chain**
```
Data Sources (VPC, Subnets, AMI)
    ‚Üì
Random Resources (Password, Bucket Suffix)
    ‚Üì
Security Groups (Web, Database)
    ‚Üì
SSH Key Pair (TLS + AWS Key Pair)
    ‚Üì
S3 Bucket + Configuration
    ‚Üì
DB Subnet Group
    ‚Üì
RDS PostgreSQL Instance
    ‚Üì
EC2 Instance
    ‚Üì
Elastic IP
```

## Terraform Commands

### **Infrastructure Lifecycle**
```bash
# Initialize Terraform
terraform init

# Validate configuration
terraform validate

# Plan infrastructure changes
terraform plan

# Apply infrastructure
terraform apply

# Destroy infrastructure
terraform destroy
```

### **Get Infrastructure Info**
```bash
# Get public IP
terraform output web_public_ip

# Get SSH command
terraform output ssh_command

# Get database URL (sensitive)
terraform output database_url

# Get S3 bucket name
terraform output s3_bucket_name
```

## GitHub Secrets Required

### **AWS Access**
- `AWS_ACCESS_KEY_ID`: AWS access key for Terraform
- `AWS_SECRET_ACCESS_KEY`: AWS secret key for Terraform

### **Application Configuration**
- `OPENROUTER_API_KEY`: AI service API key
- `JWT_SECRET`: Authentication secret

### **Auto-Generated by Terraform**
- `EC2_HOST`: Public IP of EC2 instance
- `SSH_PRIVATE_KEY`: Private SSH key for access
- `DATABASE_URL`: Complete PostgreSQL connection string
- `S3_BUCKET_NAME`: S3 bucket for uploads

## Cost Estimation

### **Monthly Costs (us-east-1)**
- **EC2 t3.small**: ~$15.00/month
- **RDS db.t3.micro**: ~$12.00/month
- **EBS 20GB**: ~$2.00/month
- **Elastic IP**: ~$3.60/month (if not attached)
- **S3 Storage**: ~$0.50/month (minimal usage)
- **Data Transfer**: ~$1.00/month

**Total**: ~$30-35/month running, ~$5/month hibernated

## Security Configuration

### **Network Security**
- **SSH**: Key-based authentication only
- **Database**: Private subnets, security group restricted
- **Web Traffic**: Nginx reverse proxy
- **S3**: Private bucket with encryption

### **Application Security**
- **Environment Variables**: Secrets via .env files
- **JWT Authentication**: Secure token-based auth
- **Input Validation**: Express validator middleware
- **CORS**: Configured for frontend domain

## User Data Setup

### **EC2 Initialization**
```bash
#!/bin/bash
apt-get update
apt-get install -y nginx curl

# Install Node.js 20.x
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
apt-get install -y nodejs

# Install PM2 globally
npm install -g pm2

# Configure nginx
systemctl start nginx
systemctl enable nginx
echo "<h1>ShopMefy Server Ready</h1>" > /var/www/html/index.html

# Create app directory
mkdir -p /home/ubuntu/shopmefy
chown ubuntu:ubuntu /home/ubuntu/shopmefy
```

## Terraform Outputs

### **Infrastructure Information**
```hcl
output "web_public_ip" {
  description = "Public IP address of the web server"
  value       = aws_eip.web.public_ip
}

output "ssh_command" {
  description = "SSH command to connect to the server"
  value       = "ssh -i ${aws_key_pair.main.key_name}.pem ubuntu@${aws_eip.web.public_ip}"
}

output "database_url" {
  description = "Complete database URL"
  value       = "postgresql://shopmefy:${random_password.db_password.result}@${split(":", aws_db_instance.postgres.endpoint)[0]}:5432/shopmefy"
  sensitive   = true
}

output "s3_bucket_name" {
  description = "S3 bucket name for deployments"
  value       = aws_s3_bucket.deployments.bucket
}

output "ssh_private_key" {
  description = "SSH private key for connecting to the server"
  value       = tls_private_key.main.private_key_pem
  sensitive   = true
}
```

## Troubleshooting

### **Common Issues**
1. **AWS Credentials**: Ensure proper IAM permissions for EC2, RDS, S3, VPC
2. **Region Availability**: Some instance types may not be available in all AZs
3. **Subnet Conflicts**: Default VPC may have limited subnets
4. **Security Groups**: Ensure proper port access for application

### **Validation Steps**
```bash
# Check Terraform syntax
terraform validate

# Check AWS credentials
aws sts get-caller-identity

# Check resource plan
terraform plan

# Check state
terraform show
```

## Next Steps After Infrastructure

### **1. Configure GitHub Secrets**
- Add AWS credentials to GitHub repository
- Add application secrets (OPENROUTER_API_KEY, JWT_SECRET)

### **2. Run Deployment**
- Trigger deploy.yml workflow
- Monitor deployment logs
- Verify application health

### **3. Access Application**
- Frontend: `http://{EC2_HOST}/`
- Backend API: `http://{EC2_HOST}/api`
- SSH: `ssh -i key.pem ubuntu@{EC2_HOST}`

## Infrastructure Benefits

### **Simplified Architecture**
- ‚úÖ Single EC2 instance for both frontend and backend
- ‚úÖ Managed RDS for database reliability
- ‚úÖ S3 for file storage and uploads
- ‚úÖ Elastic IP for consistent access

### **Cost Optimization**
- ‚úÖ Right-sized instances (t3.small for app, t3.micro for DB)
- ‚úÖ Minimal storage allocation with auto-scaling
- ‚úÖ Default VPC to avoid NAT gateway costs
- ‚úÖ Single AZ deployment for development

### **Development Friendly**
- ‚úÖ Easy SSH access for debugging
- ‚úÖ Direct git-based deployment
- ‚úÖ Real-time log monitoring
- ‚úÖ Quick infrastructure recreation

