name: ðŸ“¦ 02 - BUILD - Download Artifacts and Upload to S3

on:
  workflow_run:
    workflows: ["ðŸ§ª CI - Continuous Integration"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Build Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev

env:
  AWS_REGION: us-east-1

jobs:
  download-and-upload:
    name: ðŸ“¦ Download Artifacts and Upload to S3
    runs-on: ubuntu-latest
    environment: dev
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ðŸ”„ Checkout Code (for deployment info)
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Set Environment Variables
        run: |
          echo "BUILD_VERSION=build-$(date +%Y%m%d-%H%M%S)-$(echo $GITHUB_SHA | cut -c1-8)" >> $GITHUB_ENV
          echo "ðŸ·ï¸ Build version: build-$(date +%Y%m%d-%H%M%S)-$(echo $GITHUB_SHA | cut -c1-8)"

      - name: âš™ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ“¥ Download Backend Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./backend-artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id || github.run_id }}

      - name: ðŸ“¥ Download Frontend Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./frontend-artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id || github.run_id }}

      - name: ðŸ“¦ Package Deployment Artifacts
        run: |
          echo "ðŸ“¦ Creating deployment package from downloaded artifacts..."
          
          # Create deployment structure
          mkdir -p deployment/backend
          mkdir -p deployment/frontend
          
          # Copy backend artifacts
          cp -r backend-artifacts/* deployment/backend/
          
          # Copy frontend artifacts
          cp -r frontend-artifacts/* deployment/frontend/
          
          # Create deployment info
          cat > deployment/deployment-info.json << EOF
          {
            "version": "${{ env.BUILD_VERSION }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "$GITHUB_SHA",
            "branch": "$GITHUB_REF_NAME",
            "environment": "${{ github.event.inputs.environment || 'dev' }}",
            "source": "artifacts-from-ci"
          }
          EOF
          
          # Create archive
          echo "ðŸ—œï¸ Creating deployment archive..."
          tar -czf deployment.tar.gz -C deployment .
          
          echo "ðŸ“Š Package created: $(du -sh deployment.tar.gz)"
          echo "ðŸ“‹ Contents:"
          tar -tzf deployment.tar.gz | head -20

      - name: â˜ï¸ Upload Build to S3
        run: |
          echo "â˜ï¸ Uploading build artifacts to S3..."
          
          # Upload versioned build
          aws s3 cp deployment.tar.gz "s3://${{ secrets.AWS_S3_BUCKET }}/deployments/${{ env.BUILD_VERSION }}.tar.gz"
          
          # Upload as latest
          aws s3 cp deployment.tar.gz "s3://${{ secrets.AWS_S3_BUCKET }}/deployments/latest.tar.gz"
          
          # Upload deployment info
          aws s3 cp deployment/deployment-info.json "s3://${{ secrets.AWS_S3_BUCKET }}/deployments/${{ env.BUILD_VERSION }}-info.json"
          aws s3 cp deployment/deployment-info.json "s3://${{ secrets.AWS_S3_BUCKET }}/deployments/latest-info.json"
          
          echo "âœ… Upload completed to S3!"

      - name: ðŸ“Š Build Summary
        run: |
          echo "## ðŸ“¦ Build Package Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ env.BUILD_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: $GITHUB_REF_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: Downloaded from CI artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ S3 Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- **Versioned**: \`s3://${{ secrets.AWS_S3_BUCKET }}/deployments/${{ env.BUILD_VERSION }}.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest**: \`s3://${{ secrets.AWS_S3_BUCKET }}/deployments/latest.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Ready for Deployment:" >> $GITHUB_STEP_SUMMARY
          echo "Use the **DEPLOY** workflow to deploy this build to EC2." >> $GITHUB_STEP_SUMMARY