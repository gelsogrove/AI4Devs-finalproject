# 🏗️ Create AWS Infrastructure for ShopMefy
# This workflow creates complete AWS infrastructure from scratch
# - EC2 t3.micro with hibernation enabled
# - RDS PostgreSQL db.t3.micro
# - S3 bucket for deployments
# - Elastic IP (fixed IP address)
# - Security Groups and networking

name: 🏗️ Create AWS Infrastructure

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.6.0

jobs:
  apply:
    name: 🏗️ Create Infrastructure
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: ⚙️ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: 🔧 Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: 🔧 Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: ✅ Terraform Validate
        working-directory: ./terraform
        run: terraform validate

      - name: 🚀 Terraform Apply
        working-directory: ./terraform
        run: terraform apply -auto-approve

      - name: 📊 Show Outputs
        working-directory: ./terraform
        run: |
          echo "## 🎉 Infrastructure Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Connection Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Public IP**: $(terraform output -raw web_public_ip)" >> $GITHUB_STEP_SUMMARY
          echo "- **SSH Command**: \`$(terraform output -raw ssh_command)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket**: $(terraform output -raw s3_bucket_name)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🎯 Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Your infrastructure is ready for deployment" >> $GITHUB_STEP_SUMMARY
          echo "2. Use the **Deploy Application** workflow to deploy your app" >> $GITHUB_STEP_SUMMARY
          echo "3. Use **Pause Infrastructure** to save costs when not in use" >> $GITHUB_STEP_SUMMARY

      - name: 🤖 Auto-Update GitHub Secrets
        working-directory: ./terraform
        continue-on-error: true
        run: |
          # Get all outputs
          S3_BUCKET=$(terraform output -raw s3_bucket_name)
          EC2_HOST=$(terraform output -raw web_public_ip)
          DB_HOST=$(terraform output -raw database_host)
          DB_PASSWORD=$(terraform output -raw database_password)
          DATABASE_URL=$(terraform output -raw database_url)
          
          echo "🔄 Updating GitHub Secrets for DEV environment..."
          
          # Install GitHub CLI if not available
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          fi
          
          # Authenticate with GitHub token
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          
          # Update infrastructure secrets in DEV environment
          echo "$S3_BUCKET" | gh secret set S3_BUCKET_NAME --repo ${{ github.repository }} --env dev
          echo "$EC2_HOST" | gh secret set EC2_HOST --repo ${{ github.repository }} --env dev
          echo "ubuntu" | gh secret set EC2_USER --repo ${{ github.repository }} --env dev
          echo "us-east-1" | gh secret set AWS_REGION --repo ${{ github.repository }} --env dev
          
          # Add database secrets
          echo "$DATABASE_URL" | gh secret set DATABASE_URL --repo ${{ github.repository }} --env dev
          echo "shopmefy" | gh secret set DB_NAME --repo ${{ github.repository }} --env dev
          echo "shopmefy" | gh secret set DB_USER --repo ${{ github.repository }} --env dev
          echo "$DB_PASSWORD" | gh secret set DB_PASSWORD --repo ${{ github.repository }} --env dev
          echo "$DB_HOST" | gh secret set DB_HOST --repo ${{ github.repository }} --env dev
          
          echo "✅ All secrets updated automatically!"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🎉 GitHub Secrets Auto-Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ S3_BUCKET_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ EC2_HOST" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ EC2_USER" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ AWS_REGION" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ DATABASE_URL" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ DB_NAME, DB_USER, DB_PASSWORD, DB_HOST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🚀 Ready for Deployment!" >> $GITHUB_STEP_SUMMARY
          echo "Your infrastructure is ready and all secrets are configured!" >> $GITHUB_STEP_SUMMARY 