# ğŸ—ï¸ Create AWS Infrastructure for ShopMefy
# This workflow creates complete AWS infrastructure from scratch
# - EC2 t3.micro with hibernation enabled
# - RDS PostgreSQL db.t3.micro
# - S3 bucket for deployments
# - Elastic IP (fixed IP address)
# - Security Groups and networking

name: ğŸ—ï¸ Create AWS Infrastructure

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.6.0

jobs:
  apply:
    name: ğŸ—ï¸ Create Infrastructure
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ğŸ”§ Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: âœ… Terraform Validate
        working-directory: ./terraform
        run: terraform validate

      - name: ğŸš€ Terraform Apply
        id: apply
        working-directory: ./terraform
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        run: |
          echo "ğŸš€ Starting infrastructure deployment..."
          terraform apply -auto-approve
          echo "âœ… Infrastructure deployed successfully!"

      - name: ğŸ“Š Show Outputs
        if: success()
        working-directory: ./terraform
        run: |
          echo "## ğŸ‰ Infrastructure Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Connection Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Public IP**: $(terraform output -raw web_public_ip)" >> $GITHUB_STEP_SUMMARY
          echo "- **SSH Command**: \`$(terraform output -raw ssh_command)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket**: $(terraform output -raw s3_bucket_name)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Your infrastructure is ready for deployment" >> $GITHUB_STEP_SUMMARY
          echo "2. Use the **Deploy Application** workflow to deploy your app" >> $GITHUB_STEP_SUMMARY
          echo "3. Use **Pause Infrastructure** to save costs when not in use" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ¤– Auto-Update GitHub Secrets
        if: success()
        working-directory: ./terraform
        continue-on-error: true
        run: |
          # Get all outputs
          S3_BUCKET=$(terraform output -raw s3_bucket_name)
          EC2_HOST=$(terraform output -raw web_public_ip)
          SSH_PRIVATE_KEY=$(terraform output -raw ssh_private_key)
          DB_HOST=$(terraform output -raw database_host)
          DB_PASSWORD=$(terraform output -raw database_password)
          DATABASE_URL=$(terraform output -raw database_url)
          
          echo "ğŸ”„ Updating GitHub Secrets for DEV environment..."
          
          # Install GitHub CLI if not available
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          fi
          
          # Authenticate with GitHub token
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          
          # Update infrastructure secrets in DEV environment
          echo "$S3_BUCKET" | gh secret set S3_BUCKET_NAME --repo ${{ github.repository }} --env dev
          echo "$EC2_HOST" | gh secret set EC2_HOST --repo ${{ github.repository }} --env dev
          echo "ubuntu" | gh secret set EC2_USER --repo ${{ github.repository }} --env dev
          echo "us-east-1" | gh secret set AWS_REGION --repo ${{ github.repository }} --env dev
          echo "$SSH_PRIVATE_KEY" | gh secret set EC2_SSH_KEY --repo ${{ github.repository }} --env dev
          
          # Add database secrets
          echo "$DATABASE_URL" | gh secret set DATABASE_URL --repo ${{ github.repository }} --env dev
          echo "shopmefy" | gh secret set DB_NAME --repo ${{ github.repository }} --env dev
          echo "shopmefy" | gh secret set DB_USER --repo ${{ github.repository }} --env dev
          echo "$DB_PASSWORD" | gh secret set DB_PASSWORD --repo ${{ github.repository }} --env dev
          echo "$DB_HOST" | gh secret set DB_HOST --repo ${{ github.repository }} --env dev
          
          echo "âœ… All secrets updated automatically!"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ‰ GitHub Secrets Auto-Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… S3_BUCKET_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… EC2_HOST" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… EC2_USER" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AWS_REGION" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… EC2_SSH_KEY (Auto-generated)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… DATABASE_URL" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… DB_NAME, DB_USER, DB_PASSWORD, DB_HOST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ Ready for Deployment!" >> $GITHUB_STEP_SUMMARY
          echo "Your infrastructure is ready and all secrets are configured!" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ§¹ Cleanup on Failure
        if: failure()
        working-directory: ./terraform
        run: |
          echo "âŒ Deployment failed! Starting automatic cleanup..."
          echo "ğŸ§¹ Destroying any partially created resources..."
          
          # Try to destroy any resources that were created
          terraform destroy -auto-approve || echo "âš ï¸ Some resources may need manual cleanup"
          
          echo "ğŸ§¹ Cleanup completed"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âŒ Deployment Failed - Auto Cleanup Executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ§¹ Cleanup Actions:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Automatic cleanup executed** - Partially created resources destroyed" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ’° **No ongoing costs** - Failed resources have been cleaned up" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”„ **Safe to retry** - You can run the workflow again" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the error logs above to understand what failed" >> $GITHUB_STEP_SUMMARY
          echo "2. Fix any configuration issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Run the workflow again - no conflicts expected" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“‹ Final Status
        if: always()
        run: |
          if [ "${{ steps.apply.outcome }}" == "success" ]; then
            echo "ğŸ‰ Infrastructure deployment completed successfully!"
          else
            echo "âŒ Infrastructure deployment failed but cleanup was executed"
          fi 