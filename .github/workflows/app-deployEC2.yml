# ğŸ“¦ Upload ShopMefy Application to S3
# 
# REQUIRED GITHUB SECRETS:
# - AWS_ACCESS_KEY_ID: AWS access key for S3 upload
# - AWS_SECRET_ACCESS_KEY: AWS secret key for S3 upload
# - AWS_S3_BUCKET: shopmefy-deployments-9e11c04f
#
# CURRENT INFRASTRUCTURE:
# - S3 Bucket: shopmefy-deployments-9e11c04f

name: ğŸ“¦ CI - Upload to S3

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Upload Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
  # Auto-upload after successful CI/CD on main branch
  workflow_run:
    workflows: ["ğŸ§ª CI - Test & Build Code"]
    types:
      - completed
    branches:
      - main

env:
  AWS_REGION: us-east-1

jobs:
  upload:
    name: ğŸ“¦ Upload to S3
    runs-on: ubuntu-latest
    environment: dev
    # Only run if CI/CD was successful or if manually triggered
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ¯ Set Environment
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "UPLOAD_ENV=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
            echo "Manual upload to ${{ github.event.inputs.environment }}"
          else
            echo "UPLOAD_ENV=dev" >> $GITHUB_ENV
            echo "Auto upload to dev after successful CI/CD"
          fi

      - name: âš™ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ“¥ Download Backend Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./backend
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: ğŸ“¥ Download Frontend Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./frontend
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: ğŸ“¦ Generate ZIP Archives
        run: |
          echo "Generating ZIP archives using script..."
          chmod +x scripts/generate-zip-archives.sh
          ./scripts/generate-zip-archives.sh
          ls -la *.zip

      - name: ğŸ“¤ Upload Archives to S3
        run: |
          echo "Uploading backend.zip to S3..."
          aws s3 cp backend.zip s3://${{ secrets.AWS_S3_BUCKET }}/deployments/backend.zip
          
          echo "Uploading frontend.zip to S3..."
          aws s3 cp frontend.zip s3://${{ secrets.AWS_S3_BUCKET }}/deployments/frontend.zip
          
          echo "âœ… Upload to S3 completed successfully!"
          echo "ğŸ“¦ Backend: s3://${{ secrets.AWS_S3_BUCKET }}/deployments/backend.zip"
          echo "ğŸ“¦ Frontend: s3://${{ secrets.AWS_S3_BUCKET }}/deployments/frontend.zip"

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          rm -f backend.zip frontend.zip
